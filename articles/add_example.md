# add 上手实例解析

#### c 源代码（add.c）

```c
int add(int a, int b){
    return a+b;
}
```



#### 编译指令（emcc）

```bash
emcc add.c -Os -s "EXPORTED_FUNCTIONS=['_add']" -o add.wasm
```



#### 转为可读 “S表达式” （wabt）

```bash
wasm2wat add.wasm > add.wat
```



#### S表达式（add.wat）

```
(module
  (type (;0;) (func (param i32 i32) (result i32)))
  (func (;0;) (type 0) (param i32 i32) (result i32)
    local.get 0
    local.get 1
    i32.add)
  (export "_add" (func 0)))
```



#### 二进制格式（add.wasm）

```
0x00 0x61 0x73 0x6d
0x01 0x00 0x00 0x00
0x01 0x07 0x01 0x60 0x02 0x7f 0x7f 0x01 0x7f
0x03 0x02 0x01 0x00
0x07 0x08 0x01 0x04 0x5f 0x61 0x64 0x64 0x00 0x00
0x0a 0x09 0x01 0x07 0x00 0x20 0x00 0x20 0x01 0x6a 0x0b
```



## 解析

该 wasm 程序在二进制存储时 **分为数段**，每段在上文二进制格式中 **各占一行**，下面进行逐行解析：

#### magic 段

此段为每个二进制 wasm 文件 **必有** 的 magic 标识，其内容固定，对应 “x\00asm”

#### version 段

此段为每个二进制 wasm 文件 **必有** 的 version 标识，其内容表示 wasm 版本号，长度固定四字节，目前 WebAssemby 版本号为 1.0，所以内容为 0x01

#### type 段（ID 1）

此段为该二进制 wasm module 中所有函数的定义，包含了函数形参和返回值的信息

第一个字节 `0x01` 为段 ID 标识，type 段 ID 固定为 1

第二个字节 `0x07` 为段长度标识，表示 **自该字节之后** 该段以字节为单位的剩余长度

第三个字节 `0x01` 为函数数量标识，表示该段所示 **函数表** 的长度，此处为 “包含一个函数”

第四个字节 `0x60` 为函数类型标识，表示一个函数定义的开始

第五个字节 `0x02` 为形参数量标识，表示当前函数的形参数量，此处为 “包含两个形参”

第六个字节 `0x7f` 为形参类型标识，表示第一个形参的类型为 i32

第七个字节 `0x7f` 为形参类型标识，表示第二个形参的类型为 i32

第八个字节 `0x01` 为返回值数量表示，表示当前函数有一个返回值，wasm 1.0 只支持一个或无返回值的函数

第九个字节 `0x7f` 为返回值类型表示，表示当前函数返回值类型为 i32

#### function 段（ID 3）

此段为该二进制 wasm module 中 **code 段中函数 与 type 段中定义 对应关系** 的定义

第一个字节 `0x03` 为段 ID 标识，function 段 ID 固定为 3

第二个字节 `0x02` 为段长度标识，表示 **自该字节之后** 该段以字节为单位的剩余长度

第三个字节 `0x01` 为函数数量标识，表示该段所示对应表的长度，此处为 “包含一个函数”

第四个字节 `0x00` 为对应关系标识，表示 **code 段中定义的第一个函数与 type 段中序号为 0 的定义对应**

（注：在 type 和 code 段中，定义/函数 的序号均自 0 递增，此处对应表的第 n 项所示即序号为 n-1 函数的情况）

#### export 段（ID 7）

此段为该二进制 wasm module 中 **导出函数** 的定义

第一个字节 `0x07` 为段 ID 标识，export 段 ID 固定为 7

第二个字节 `0x08` 为段长度标识，表示 **自该字节之后** 该段以字节为单位的剩余长度

第三个字节 `0x01` 为函数数量标识，表示该段所示 **导出函数表** 的长度，此处为 “包含一个函数”

第四个字节 `0x04` 为当前导出函数名长度标识，表示当前描述函数 **不包括结束字符** 的函数名长度

第五至八字节 `0x5f 0x61 0x64 0x64` 为导出函数名，长度如上描述四字节，内容为 “_add”

第九个字节 `0x00` 为函数名结束字符

第十个字节 `0x00` 为导出函数序号，此处表示该导出函数在 **code段中序号为 0**

#### code 段（ID 10）

此段为该二进制 wasm module 中 **函数体** 的定义

第一个字节 `0x0a` 为段 ID 标识，code 段 ID 固定为 10

第二个字节 `0x09` 为段长度标识，表示 **自该字节之后** 该段以字节为单位的剩余长度

第三个字节 `0x01` 为函数数量标识，表示该段所示 **函数体表** 的长度，此处为 “包含一个函数体”

第四个字节 `0x07` 为当前描述函数体长度标识，表示当前描述函数 **整个函数体** 的长度，包括起始和块终止字符

第五个字节 `0x00` 为局部变量数量标识，此处为 “无局部变量”

第六个字节 `0x20` 为 local.get 指令，表示取局部变量压入栈顶

第七个字节 `0x00` 为指令操作数，表示取序号为 0 的局部变量，即第一个形参

第八个字节 `0x20` 为 local.get 指令，表示取局部变量压入栈顶

第九个字节 `0x01` 为指令操作数，表示取序号为 1 的局部变量，即第二个形参

第十个字节 `0x6a` 为 int32.add 指令，表示从栈顶弹出两个 i32 数据，相加后将结果压入栈顶

第十一个字节 `0x0b` 为块终止字符，表示一个代码块的结束



## 总结

此实例中出现的段较少，大多数段的存储都遵循类似的规则：

+ 第一个字节为 **ID 标识**
+ 第二个字节为 **段长度标识**
+ 第三个字节为 **列表长度标识**
+ 第四个字节为 **第一个列表项长度标识**

+ etc.
